# Nginx configuration for Laravel on aaPanel Ubuntu
# Place this configuration in aaPanel > Website > Domain > Config > Nginx

server {
    listen 80;
    listen 443 ssl http2;
    server_name backpinjam.unugha.ac.id;
    
    # SSL Configuration (aaPanel will handle SSL certificates)
    # ssl_certificate /path/to/certificate.crt;
    # ssl_certificate_key /path/to/private.key;
    
    root /www/wwwroot/backpinjam.unugha.ac.id/public;
    index index.php index.html index.htm;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # CORS headers for API
    add_header Access-Control-Allow-Origin "https://sipinjamku.unugha.ac.id" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-XSRF-TOKEN" always;
    add_header Access-Control-Allow-Credentials "true" always;
    
    # Handle preflight requests
    location / {
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://sipinjamku.unugha.ac.id";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-XSRF-TOKEN";
            add_header Access-Control-Allow-Credentials "true";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 200;
        }
        
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHP handling
    location ~ \.php$ {
        fastcgi_pass unix:/tmp/php-cgi-81.sock;  # Adjust PHP version as needed
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # PHP configuration
        fastcgi_param PHP_VALUE "upload_max_filesize=64M
                                post_max_size=64M
                                max_execution_time=300
                                max_input_vars=3000
                                memory_limit=256M";
    }
    
    # Deny access to sensitive files
    location ~ /\.(env|git|svn) {
        deny all;
        return 404;
    }
    
    location ~ /(composer\.(json|lock)|package\.json|yarn\.lock) {
        deny all;
        return 404;
    }
    
    location ~ /\.log$ {
        deny all;
        return 404;
    }
    
    # Static files caching
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1M;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # Force HTTPS (uncomment if SSL is configured)
    # if ($scheme != "https") {
    #     return 301 https://$server_name$request_uri;
    # }
    
    # Logging
    access_log /www/wwwlogs/backpinjam.unugha.ac.id.log;
    error_log /www/wwwlogs/backpinjam.unugha.ac.id.error.log;
}